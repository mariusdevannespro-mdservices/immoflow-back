generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String   @id @default(cuid())
  auth0Sub             String   @unique
  email                String?
  avatarKey            String?  @default("home")

  theme                String   @default("light") // "light" | "dark"

  plan                 String   @default("free")
  hasStartedFree       Boolean  @default(false)

  // ✅ NEW: lifetime flag
  proPlusLifetime      Boolean  @default(false)

  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  stripeStatus         String?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)

  // --- Fiscalité (profil utilisateur) ---
  tmi                  Int      @default(30)
  socialContribRate    Float    @default(0.172)

  createdAt            DateTime @default(now())

  projects             Project[]
  redeemedKeys         LicenseKey[] @relation("RedeemedKeys")
}

model LicenseKey {
  id            String   @id @default(cuid())

  // ✅ on stocke un hash, pas le code en clair
  codeHash      String   @unique

  plan          String   @default("pro_plus") // extensible plus tard
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  redeemedAt    DateTime?
  redeemedById  String?
  redeemedBy    User?    @relation("RedeemedKeys", fields: [redeemedById], references: [id], onDelete: SetNull)

  @@index([redeemedById])
  @@index([isActive])
}

model Project {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  city         String
  propertyType String

  // --- Acquisition ---
  price           Int
  notaryFees      Int?
  renovationCosts Int?
  landShareRate   Float? @default(0.15)

  // --- Financement ---
  contribution Int
  loanAmount   Int
  interestRate Float
  duration     Int

  // --- Revenus ---
  monthlyRent               Int
  vacancyRate               Float?
  rentChargesIncluded       Boolean @default(false)
  recoverableChargesMonthly Int?
  otherIncomeMonthly        Int?

  // --- Charges ---
  propertyTax     Int?
  coOwnershipFees Int?
  insurance       Int?
  maintenance     Int?

  propertyManagementFeeRate     Float?
  propertyManagementFeeMonthly  Int?
  rentGuaranteeInsuranceMonthly Int?
  accountingFeesAnnual          Int?
  expectedCapexAnnual           Int?

  taxMode   String  @default("micro")
  furnished Boolean @default(true)

  depreciationAssets DepreciationAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([taxMode])
}

model DepreciationAsset {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  category  String
  label     String
  amount    Int
  years     Int

  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([category])
}
